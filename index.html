<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Akela Toolbox</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: auto; padding: 2rem; background: #f4f4f4; }
    nav button { margin-right: 1rem; padding: 0.5rem 1rem; cursor: pointer; }
    section { display: none; background: white; padding: 1rem; border-radius: 4px; margin-top: 1rem; }
    section.active { display: block; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.5rem; border: 1px solid #ccc; text-align: left; }
    input, select, textarea { width: 100%; margin-bottom: 1rem; padding: 0.5rem; font-size: 1rem; }
    button.submit-btn { padding: 0.5rem 1rem; }
  </style>
</head>
<body>

  <h1>Akela Toolbox</h1>

  <nav>
    <button data-target="home">Accueil</button>
    <button data-target="list">üìö Liste des jeux Louveteaux</button>
    <button data-target="generator">üõ† G√©n√©rateur de programmes</button>
    <button data-target="submit">‚ûï Soumettre un nouveau jeu</button>
  </nav>

  <!-- Accueil -->
  <section id="home" class="active">
    <h2>Bienvenue dans Akela Toolbox !</h2>
    <p>Facilitez la pr√©paration d'activit√©s Louveteaux avec nos outils collaboratifs.</p>
  </section>

  <!-- Liste des jeux -->
  <section id="list">
    <h2>üìö Liste des jeux Louveteaux</h2>
    <input id="search" type="text" placeholder="üîç Rechercher par mot-cl√©" />
    <table>
      <thead>
        <tr><th>Nom</th><th>Dur√©e</th><th>Mat√©riel</th><th>Objectif</th><th>Description</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <!-- G√©n√©rateur de programmes -->
<section id="generator">
  <h2>üí¨ AkelaAI (Powered by Mistral)</h2>

  <textarea id="userPrompt" rows="5" placeholder="Ex : G√©n√®re un programme du samedi 10h au dimanche 16h, th√®me jungle, objectif coh√©sion, trajet 30 min" disabled></textarea>
  <button id="sendBtn" disabled>Chargement des jeux...</button>

  <h2>üß† R√©ponse :</h2>
  <div id="program-output" style="white-space: pre-wrap; margin-top: 1rem; background: #eef; padding: 1rem; border-radius: 4px; min-height: 150px;">En attente...</div>
</section>


  <!-- Soumission nouveau jeu -->
  <section id="submit">
    <h2>‚ûï Soumettre un nouveau jeu</h2>
    <form id="submit-form">
      <label>Nom: <input type="text" id="new-name" required></label>
      <label>Dur√©e (min): <input type="number" id="new-duration" required></label>
      <label>Mat√©riel: <input type="text" id="new-material" required></label>
      <label>Objectif: <input type="text" id="new-goal" required></label>
      <label>Description: <textarea id="new-description" rows="4" required></textarea></label>
      <button type="submit" class="submit-btn">Envoyer</button>
    </form>
    <div id="submit-result" style="margin-top: 1rem;"></div>
  </section>

  <script>
  // Navigation simple
  const buttons = document.querySelectorAll("nav button");
  const sections = document.querySelectorAll("section");
  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const target = btn.dataset.target;
      sections.forEach(sec => sec.classList.toggle("active", sec.id === target));
    });
  });

  // Donn√©es CSV depuis Google Sheets
  const csvUrl = "https://docs.google.com/spreadsheets/d/10uIzf1QjEqgZn9OCvxaONA5va1T8xgT8p40eCXftSec/export?format=csv&gid=0";

  // Parser CSV
  function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines.shift().split(",").map(h => h.trim());
    return lines.map(line => {
      const values = line.split(",").map(v => v.trim());
      let obj = {};
      headers.forEach((h, i) => {
        obj[h] = values[i] || "";
      });
      return obj;
    });
  }

  // Render jeux + recherche
  const tbody = document.getElementById("tbody");
  const searchInput = document.getElementById("search");
  let rows = [];

  function render(data) {
    tbody.innerHTML = "";
    if (data.length === 0) {
      tbody.innerHTML = "<tr><td colspan='5'>Aucun r√©sultat trouv√©.</td></tr>";
      return;
    }
    for (const row of data) {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.Nom}</td>
        <td>${row.Dur√©e}</td>
        <td>${row.Mat√©riel}</td>
        <td>${row.Objectif}</td>
        <td>${row.Description}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  fetch(csvUrl)
    .then(res => res.text())
    .then(text => {
      rows = parseCSV(text);
      render(rows);
    })
    .catch(() => {
      tbody.innerHTML = "<tr><td colspan='5'>Erreur de chargement des donn√©es.</td></tr>";
    });

  searchInput.addEventListener("input", () => {
    const query = searchInput.value.toLowerCase();
    const filtered = rows.filter(row =>
      Object.values(row).some(val => val.toLowerCase().includes(query))
    );
    render(filtered);
  });

  // G√©n√©rateur de programmes
  // On conserve les fonctions parseCSV et la variable csvUrl ainsi que la r√©cup√©ration des jeux dans rows

let games = [];  // on utilisera games pour la base compl√®te

// Charger et parser la base CSV (remplace fetch csvUrl dans la partie list aussi, pour √©viter double fetch)
fetch(csvUrl)
  .then(res => res.text())
  .then(text => {
    games = parseCSV(text);
    render(rows); // On continue d‚Äôafficher la liste comme avant (rows === games)
    
    // Apr√®s chargement, activer textarea + bouton dans la section g√©n√©rateur
    const sendBtn = document.getElementById("sendBtn");
    const userPrompt = document.getElementById("userPrompt");
    sendBtn.disabled = false;
    sendBtn.textContent = "Envoyer √† AkelaAI";
    userPrompt.disabled = false;
  })
  .catch(() => {
    tbody.innerHTML = "<tr><td colspan='5'>Erreur de chargement des donn√©es.</td></tr>";
    alert("Impossible de charger les jeux. R√©essayez plus tard.");
  });

// Pr√©fixe prompt IA
const PREFIX_PROMPT = `Tu es un assistant scout expert dans l‚Äôorganisation d‚Äôactivit√©s pour les Louveteaux.

Ton r√¥le est de g√©n√©rer des programmes d√©taill√©s pour des week-ends ou journ√©es scoutes, selon des param√®tres donn√©s par un chef.

Les jeux que tu inclus proviennent uniquement de la base de donn√©es fournie et les timings sont coherents.

horaires imposes:
- Montage des tentes en debut d'apres midi
- 60 minutes de preparation du diner/de la veillee
- Le d√Æner dure 60 minutes.
- La veill√©e dure 90 minutes.
- Le coucher est toujours √† 21h00 maximum. Si une activit√© d√©passe, elle est coup√©e.
- Dodo de 21h00 √† 8h15.
- 08h15‚Äì08h30 : R√©veil et d√©rouillage (15 min)
- 08h30‚Äì09h15 : Petit d√©jeuner (45 min)
- 09h15‚Äì09h45 : D√©sinstallation (30 min)
- Rassemblement final 10 minutes a la fin du weekend
- JAMAIS DE TEMPS LIBRE SAUF POUR LE SOMMEIL LA NUIT

Tes r√©ponses sont toujours tr√®s br√®ves (sauf pour les jeux dont tu fais une description copiee collee de la base de donnees) et en texte pur.

Commence maintenant avec le prompt utilisateur suivant :
`;

const API_KEY = "ySiMyJNfTK46OI3TYjDsu1wUqYGBvXeN";

async function sendPrompt() {
  const userInput = document.getElementById("userPrompt").value.trim();
  if (!userInput) {
    alert("Veuillez saisir un prompt.");
    return;
  }

  const programOutput = document.getElementById("program-output");
  programOutput.textContent = "‚è≥ Chargement...";

  try {
    // Construire prompt complet
    const gamesString = JSON.stringify(games, null, 2);
    const fullPrompt = `${PREFIX_PROMPT}\nBase de donn√©es jeux :\n${gamesString}\n\n${userInput}`;

    const res = await fetch("https://api.mistral.ai/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${API_KEY}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        model: "mistral-medium",
        messages: [{ role: "user", content: fullPrompt }],
        temperature: 0.7
      })
    });

    if (!res.ok) throw new Error("Erreur HTTP : " + res.status);
    const data = await res.json();
    const reply = data.choices?.[0]?.message?.content || "‚ùå Pas de r√©ponse.";

    programOutput.textContent = reply;

  } catch (err) {
    console.error(err);
    programOutput.textContent = "‚ùå Erreur lors de l'appel √† l'API.";
  }
}

// Lier l‚Äô√©v√©nement au bouton
document.getElementById("sendBtn").addEventListener("click", sendPrompt);


  // Soumission nouveau jeu en GET avec params dans l'URL
  const submitForm = document.getElementById("submit-form");
  const submitResult = document.getElementById("submit-result");

  // Soumission nouveau jeu via SheetDB (POST JSON)
submitForm.addEventListener("submit", async e => {
  e.preventDefault();

  const data = {
    Nom: submitForm["new-name"].value.trim(),
    Dur√©e: submitForm["new-duration"].value.trim(),
    Mat√©riel: submitForm["new-material"].value.trim(),
    Objectif: submitForm["new-goal"].value.trim(),
    Description: submitForm["new-description"].value.trim(),
  };

  try {
    const response = await fetch("https://sheetdb.io/api/v1/dtoqbws6n5hif", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data })
    });

    if (!response.ok) throw new Error(`Erreur HTTP : ${response.status}`);

    submitResult.textContent = "‚úÖ Merci ! Jeu soumis avec succ√®s.";
    submitForm.reset();
    submitResult.textContent = "‚úÖ Merci ! Jeu soumis avec succ√®s.";
// Bloquer l'√©cran (optionnel, par exemple en d√©sactivant le formulaire ou en affichant un overlay)
submitForm.querySelectorAll("input, textarea, button").forEach(el => el.disabled = true);

// Attendre 2 secondes puis rafra√Æchir la page
setTimeout(() => {
  location.reload();
}, 2000);

  } catch (err) {
    submitResult.textContent = "‚ùå Erreur r√©seau ou serveur : " + err.message;
  }
});

  </script>

</body>
</html>
