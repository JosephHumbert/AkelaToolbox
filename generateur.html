<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Akela Toolbox - G√©n√©rateur</title>
  <meta name="description" content="G√©n√©rez un programme d‚Äôactivit√©s Louveteaux gr√¢ce √† AkelaAI.">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="index, follow">
  <link rel="stylesheet" href="http://localhost:8000/site13/style.css">
</head>

<body>
  <h1>üê∫ Akela Toolbox</h1>

  <!-- Navbar -->
  <div id="navbar"></div>
  <script>
    fetch('http://localhost:8000/site13/includes/navbar.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('navbar').innerHTML = html;
      });
  </script>

  <!-- Section G√©n√©rateur -->
  <section id="generator" class="active">
    <h2>üí¨ AkelaAI (Powered by Mistral)</h2>

    <p>D√©cris ton week-end ou journ√©e Louveteaux, et AkelaAI g√©n√©rera un programme adapt√©, √† partir des jeux connus.</p>

    <textarea id="userPrompt" placeholder="Ex : G√©n√®re un programme du samedi 10h au dimanche 16h, th√®me jungle, objectif coh√©sion, trajet 30 min" rows="6" cols="80" disabled></textarea><br>
    <button id="sendBtn" disabled>‚è≥ Chargement...</button>

    <h3>üß† R√©ponse :</h3>
    <pre id="program-output">Aucun programme g√©n√©r√© pour l‚Äôinstant.</pre>
  </section>

  <!-- Footer -->
  <div id="footer"></div>
  <script>
    fetch("http://localhost:8000/site13/includes/footer.html")
      .then(res => res.text())
      .then(html => document.getElementById("footer").innerHTML = html);
  </script>

  <!-- Script principal -->
  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/10uIzf1QjEqgZn9OCvxaONA5va1T8xgT8p40eCXftSec/export?format=csv&gid=0";
    let games = [];

    function parseCSV(text) {
      const lines = text.trim().split("\n");
      const headers = lines.shift().split(",").map(h => h.trim());
      return lines.map(line => {
        const values = line.split(",").map(v => v.trim());
        let obj = {};
        headers.forEach((h, i) => {
          obj[h] = values[i] || "";
        });
        return obj;
      });
    }

    fetch(csvUrl)
      .then(res => res.text())
      .then(text => {
        games = parseCSV(text);
        document.getElementById("sendBtn").disabled = false;
        document.getElementById("sendBtn").textContent = "Envoyer √† AkelaAI";
        document.getElementById("userPrompt").disabled = false;
      })
      .catch(() => {
        alert("‚ùå Erreur de chargement des jeux.");
      });

    const PREFIX_PROMPT = `Tu es un assistant scout expert dans l‚Äôorganisation d‚Äôactivit√©s pour les Louveteaux.

Ton r√¥le est de g√©n√©rer des programmes d√©taill√©s pour des week-ends ou journ√©es scoutes, selon des param√®tres donn√©s par un chef.

Les jeux que tu inclus proviennent uniquement de la base de donn√©es fournie et les timings sont coherents.

horaires imposes:
- Montage des tentes en debut d'apres midi
- 60 minutes de preparation du diner/de la veillee
- Le d√Æner dure 60 minutes.
- La veill√©e dure 90 minutes.
- Le coucher est toujours √† 21h00 maximum. Si une activit√© d√©passe, elle est coup√©e.
- Dodo de 21h00 √† 8h15.
- 08h15‚Äì08h30 : R√©veil et d√©rouillage (15 min)
- 08h30‚Äì09h15 : Petit d√©jeuner (45 min)
- 09h15‚Äì09h45 : D√©sinstallation (30 min)
- Rassemblement final 10 minutes a la fin du weekend
- JAMAIS DE TEMPS LIBRE SAUF POUR LE SOMMEIL LA NUIT

Tes r√©ponses sont toujours tr√®s br√®ves (sauf pour les jeux dont tu fais une description copiee collee de la base de donnees) et en texte pur.

Commence maintenant avec le prompt utilisateur suivant :
`;

    const API_KEY = "ySiMyJNfTK46OI3TYjDsu1wUqYGBvXeN"; // ‚ö†Ô∏è √Ä remplacer c√¥t√© serveur si public

    async function sendPrompt() {
      const userInput = document.getElementById("userPrompt").value.trim();
      if (!userInput) {
        alert("Veuillez entrer une description.");
        return;
      }

      const output = document.getElementById("program-output");
      output.textContent = "‚è≥ G√©n√©ration en cours...";

      try {
        const fullPrompt = `${PREFIX_PROMPT}\nBase de donn√©es jeux :\n${JSON.stringify(games, null, 2)}\n\n${userInput}`;

        const res = await fetch("https://api.mistral.ai/v1/chat/completions", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${API_KEY}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            model: "mistral-medium",
            messages: [{ role: "user", content: fullPrompt }],
            temperature: 0.7
          })
        });

        if (!res.ok) throw new Error("Erreur HTTP : " + res.status);
        const data = await res.json();
        const reply = data.choices?.[0]?.message?.content || "‚ùå Pas de r√©ponse.";
        output.textContent = reply;

      } catch (err) {
        console.error(err);
        output.textContent = "‚ùå Erreur lors de la g√©n√©ration.";
      }
    }

    document.getElementById("sendBtn").addEventListener("click", sendPrompt);
  </script>

</body>
</html>
